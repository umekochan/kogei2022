<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尻★チェキ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.0/fabric.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        body,div,p,h1,h2,h3,h4,h5,h6,ul,ol,li,a,dt,dl,dd {box-sizing: border-box;}
        body {margin:0 auto; max-width: 1000px;}
        .tools {max-width: 640px ;}
    </style>
</head>
<body>
    <div class="canvas__wrap">
        <canvas id="Canvas" class="canvas"></canvas>
    </div>
    <div class="container">
        <div class="row">
            <div class="upload input-group mb-3"><label class="input-group-text" for="file">画像追加</label><input class="form-control" type="file" name="file" id="file"></div>
        </div>
        <div class="row">
            <div class="download mb-3"><button type="button" id="Download" class="btn btn-primary">画像をダウンロード</button></div>
        </div>
    </div>
    <footer class="row">
        <small class="fs-6 text-center">created:<a href="https://twitter.com/UmeBC" >@umebc</a></small>
    </footer>
    <div id="result"></div>
    <script>
        //画面サイズの幅上限
        const widthMax = 640;
        //fabricをロード
        const canvas = new fabric.Canvas('Canvas');
        //初期値：選択可能
        canvas.selection = true;
        //初期値：落描き無効
        canvas.isDrawingMode = false;

        //画像を読み込む
        document.getElementById('file').onchange = (e) => {
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = (f) => {
                let data = f.target.result;                    
                fabric.Image.fromURL(data, function (img) {
                    let oImg = img.set({left: 0}).scale(0.33);
                    canvas.add(oImg);
                    let a = canvas.setActiveObject(oImg);
                    // let dataURL = canvas.toDataURL({format: 'png', quality: 0.8});
                });
            }
            reader.readAsDataURL(file);
        }

        //文字を追加できる
        function createTextBox(text){
            let bg = bgTransparent.checked ? null : bgColorPicler.value;
            let textbox = new fabric.Textbox(text,{fill: colorPicker.value, backgroundColor: bg, textAlign: "center"});
            canvas.add(textbox);
            canvas.centerObject(textbox);
        }

        //画面サイズ似合わせる
        window.addEventListener('resize', resizeCanvas, false);
        function resizeCanvas() {
            let inWidth = window.innerWidth < widthMax ? window.innerWidth: widthMax;
            //背景画像の比率に合わせて高さを設定
            canvas.setHeight(inWidth * 1.364);
            canvas.setWidth(inWidth);
            canvas.renderAll();
        }
        resizeCanvas();

        //画像ダウンロード
        document.getElementById('Download').onclick = (e) => {
            let link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "kogei_Profile.png";
            link.click();
        }

        var artBoard = new fabric.Rect({
        stroke: '#000',
        strokeWidth:1,
        fill: 'rgba(0,255,255,1)',
        width: canvas.width  - 40,
        height: canvas.height  - 40,
        selectable:false,
        shadow : {
                color: 'rgba(0,0,0,0.5)',
                blur: 20,
                offsetX: 0,
                offsetY: 10,
                opacity: 0.6,
                fillShadow: true,
            }
        });

        canvas.centerObject(artBoard);
        canvas.setBackgroundImage(artBoard);

        //背景設定
        (() => {
            fabric.Image.fromURL('sirisiri13.jpg', function(bgImg) {
                bgImg.scaleToWidth(canvas.width * 0.86);
                //bgImg.scaleToHeight(canvas.height);
                canvas.setBackgroundImage(bgImg, canvas.renderAll.bind(canvas), {
                    left: (canvas.width - bgImg.width * bgImg.scaleX) / 2, top: 20
                });
	        });
        })();
        // canvas.renderAll();
    </script>
</body>
</html>