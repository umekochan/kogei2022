<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.0/fabric.min.js"></script>
    <style>
        body {margin:0 auto; max-width: 1000px;}
    </style>
</head>
<body>
    <div class="canvas__wrap">
        <canvas id="Canvas" class="canvas"></canvas>
    </div>
    <div class="upload"><input type="file" name="file" id="file"></div>
    <div class="addTextbox"><button type="button" class="addTextbox-btn" id="AddTextboxBtn">addTextBox</button></div>
    <div class="draw"><input type="checkbox" name="drawMode-check" id="DrawMode"><label for="DrawMode">落描きできるようにする</label></div>
    <div id="result"></div>
    <script>
        //fabricをロード
        const canvas = new fabric.Canvas('Canvas');
        //初期値：選択可能
        canvas.selection = true;
        //初期値：落描き無効
        canvas.isDrawingMode = false;

        //画像を読み込む
        var icon;
        document.getElementById('file').addEventListener("change", function (e) {
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = function (f) {
                let data = f.target.result;                    
                fabric.Image.fromURL(data, function (img) {
                    let oImg = img.set({left: 0}).scale(0.33);
                    canvas.add(oImg);
                    let a = canvas.setActiveObject(oImg);
                    // let dataURL = canvas.toDataURL({format: 'png', quality: 0.8});
                });
            };
            reader.readAsDataURL(file);
        });

        //文字を追加できる
        function createTextBox(text){
            let textbox = new fabric.Textbox(text);
            canvas.add(textbox);
            canvas.centerObject(textbox);
        }
        document.getElementById('AddTextboxBtn').addEventListener("click", function(e) {
            createTextBox('add');
        });

        //画面サイズ似合わせる
        window.addEventListener('resize', resizeCanvas, false);
        function resizeCanvas() {
            let inWidth = window.innerWidth < 800 ? window.innerWidth: 800;
            canvas.setHeight(window.innerHeight);
            canvas.setWidth(inWidth);
            canvas.renderAll();
        }
        resizeCanvas();

        //お絵かきモードのON/OFF
        let drawCheck = document.getElementById('DrawMode');
        drawCheck.addEventListener("change", function(e) {
            canvas.isDrawingMode = drawCheck.checked;
        });

        //背景設定
        (() => {
            fabric.Image.fromURL('sheet2022.png', function(bgImg) {
                bgImg.scaleToWidth(canvas.width);
                //bgImg.scaleToHeight(canvas.height);
                console.log(bgImg.scaleX);
                canvas.setBackgroundImage(bgImg, canvas.renderAll.bind(canvas), {
                    left: (canvas.width - bgImg.width * bgImg.scaleX) / 2
                });
	        });
        })();
    </script>
</body>
</html>