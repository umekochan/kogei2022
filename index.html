<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOGEI自己紹介2022</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.0/fabric.min.js"></script>
    <style>
        body {margin:0 auto; max-width: 1000px;}
    </style>
</head>
<body>
    <div class="canvas__wrap">
        <canvas id="Canvas" class="canvas"></canvas>
    </div>
    <div class="color"><input type="color" id="ColorPicker">描画色</div>
    <div class="bgColor"><input type="color" id="BgColorPicker">テキスト背景色</div>
    <div class="bgTransparent"><input type="checkbox" id="BgTransparent" checked="checked"><label for="BgTransparent">背景色無し</label></div>
    <div class="upload"><input type="file" name="file" id="file"></div>
    <div class="addTextbox"><button type="button" class="addTextbox-btn" id="AddTextboxBtn">テキストの追加</button></div>
    <div class="draw"><input type="checkbox" name="drawMode-check" id="DrawMode"><label for="DrawMode">落描きできるようにする</label></div>
    <div class="penWidth"><input type="range" id="PenWidth" value="1" min="1" max="100"><label for="PenWidth">ペンの太さ</label></div>
    <div class="delete"><button type="button" id="Delete">選択したやつを消す</button></div>
    <div id="result"></div>
    <script>
        //画面サイズの幅上限
        const widthMax = 640;
        //fabricをロード
        const canvas = new fabric.Canvas('Canvas');
        //初期値：選択可能
        canvas.selection = true;
        //初期値：落描き無効
        canvas.isDrawingMode = false;
        //描画色カラーピッカーを取得
        let colorPicker = document.getElementById('ColorPicker');
        //背景の有効無効
        let bgTransparent = document.getElementById('BgTransparent');
        //背景色カラーピッカーを取得
        let bgColorPicler = document.getElementById('BgColorPicker');

        //画像を読み込む
        document.getElementById('file').addEventListener("change", function (e) {
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = function (f) {
                let data = f.target.result;                    
                fabric.Image.fromURL(data, function (img) {
                    let oImg = img.set({left: 0}).scale(0.33);
                    canvas.add(oImg);
                    let a = canvas.setActiveObject(oImg);
                    // let dataURL = canvas.toDataURL({format: 'png', quality: 0.8});
                });
            };
            reader.readAsDataURL(file);
        });

        //文字を追加できる
        function createTextBox(text){
            let bg = bgTransparent.checked ? null : bgColorPicler.value;
            let textbox = new fabric.Text(text,{fill: colorPicker.value, backgroundColor: bg});
            canvas.add(textbox);
            canvas.centerObject(textbox);
        }
        document.getElementById('AddTextboxBtn').addEventListener("click", function(e) {
            createTextBox('add');
        });

        //画面サイズ似合わせる
        window.addEventListener('resize', resizeCanvas, false);
        function resizeCanvas() {
            let inWidth = window.innerWidth < widthMax ? window.innerWidth: widthMax;
            //背景画像の比率に合わせて高さを設定
            canvas.setHeight(inWidth * 1.42);
            canvas.setWidth(inWidth);
            canvas.renderAll();
        }
        resizeCanvas();

        //お絵かきモードのON/OFF
        let drawCheck = document.getElementById('DrawMode');
        drawCheck.addEventListener("change", function(e) {
            canvas.isDrawingMode = this.checked;
        });

        //お絵かきモードのペンの太さ
        let penWidth = document.getElementById('PenWidth');
        penWidth.addEventListener("change", function(e) {
            canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
        });

        //お絵かきモードのカラーを描画色に連動
        colorPicker.addEventListener("change", function(e) {
            canvas.freeDrawingBrush.color = this.value;
        });

        //選択したやつを消す
        document.getElementById('Delete').addEventListener("click", function(e) {
            let deleteYes = window.confirm("消しちゃうよ？");
            if(deleteYes){
                canvas.remove(canvas.getActiveObject());
            }
        });

        //背景設定
        (() => {
            fabric.Image.fromURL('sheet2022.png', function(bgImg) {
                bgImg.scaleToWidth(canvas.width);
                //bgImg.scaleToHeight(canvas.height);
                canvas.setBackgroundImage(bgImg, canvas.renderAll.bind(canvas), {
                    left: (canvas.width - bgImg.width * bgImg.scaleX) / 2
                });
	        });
        })();
    </script>
</body>
</html>